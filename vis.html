<!DOCTYPE html>
<html style="height: 100%">

<head>
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

</head>

<body style="height: 100%">
<div id="svgcontainer" style="height:100%"></div>
<script>
    let socket = io.connect('https://heartbeat.zaksmorgan.com');
    var width = "100%";
    var height = "100%";
    //Create SVG element
    var svg = d3.select("#svgcontainer")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    //Append HR circle
    svg.append("circle")
        .attr("cx", "50%")
        .attr("cy", "50%")
        .attr("r", 100)
        .attr("stroke", "green")
        .attr("stroke-width", 5)
        .attr("stroke-opacity", .5)
        .attr('id', 'cc')
        .attr("fill", "none");

    //Visualisation of Baseline hr
    var baseline = 50 // input from server
    svg.append("circle")
        .attr("cx", "50%")
        .attr("cy", "50%")
        .attr("r", baseline)
        .attr("stroke", "red")
        .attr("stroke-width", 5)
        .attr("stroke-opacity", 1)
        .attr("fill", "none");



    // var i = [80, 100, 120, 90, 60, 75]; //input from server

    //Changes size of radius of HR circle


    socket.on('visualise', (message) => { // After requesting data server will send this message
        // console.log(message) //-> message is a string such as "[50,23,50,20,33]"
        i = JSON.parse(message)["average"];
        // console.log(i); //-> i is now that string turned into an array such as [50,23,50,20,33]

        v = JSON.parse(message)["variance"]; // This is for the variance

        if(i.length > 0) { // If we have data, visualise it
            myLoop(0)
        }
        else{ // If we didn't get any data back then wait, then re-request it!
            setTimeout(function () {
                socket.emit('vis-request', "");
            }, 1000);
        }
    });

    function myLoop(current_index) {
        setTimeout(function () {
            var now = d3.select('#cc');
            now.transition().duration(1500).attr("r", i[current_index]).attr("stroke-opacity", v[current_index]).attr("stroke-width", v[current_index])
            if (current_index < i.length - 1) {
                myLoop(current_index + 1)
            }
            else{
                socket.emit('vis-request', ""); // When finished request more data
            }
        }, 3000);

        // change this time (in milliseconds) to whatever you desire
    }

    // myLoop(0); // first call
    socket.emit('vis-request', ""); //Request data to visualise
</script>
</body>

</html>